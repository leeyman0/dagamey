<!DOCTYPE html>
<html>
  <head>
    <title>Lesson Window</title>
    <meta charset="UTF-8">
  </head>
  <body>
    <link rel="stylesheet" type="text/css" href="gamestyle.css" media="screen" />
    <div id="gamebox"></div>
    <p id="ID">
    </p>
    <script src="./dagamey.js"></script>
    <script src="./jquery-3.6.0.min.js"></script>
    <script src="./interface.js"></script>
    <script>
      // This is where the code that connects the database to the game engine to the website is
      let exit_button = document.createElement("button");
      exit_button.id = "exit_button";
      let game_window = document.getElementById("gamebox");
      // First, supply the selection of the lesson
      // All we really need to retrieve is the number of lessons in the database
      // Some user data would be nice as well, like the completion level
      let database_data;
      //      window.addEventListener("load", function () {
      //	  let database_request = new XMLHttpRequest();
      //	  database_request.open("POST", "1b-database.php");
      //	  database_request.onLoad(function () {
      //	      // something something something
      //	  });
      //      });
      
      let ID = -1;
      window.addEventListener("load", getUserId);
      function getUserId() {
	  $.post("get_user_id.php", function(user_id) {
              //console.log("hello 1\n");
              ID = user_id;
              console.log(`Hello, user number ${ID}`);
              //console.log("hello 2\n");
          });
      }

      // This function checks the ID of the user
      // Either creates a game row if there is no data
      // or it gets the user's data
      function checkID() {
	  $.post("check_ID.php",
		 {
		     ID,
		 },
		 function (response) {
		     console.log(response);
		     if (response === 'false') {
			 createGameRow();
		     }
		 });
      }
      function load_level(lesson, level) {
	  let loaded;
	  $.post("load_level.php",
		 {
		     "lesson": lesson,
		     "level": level,
		 },
		 function (response) {
		     loaded = response;
		     console.log(response);
		 }, 'json');
	  return loaded;
      }

      let level_data = load_level(1, 1);
      
      // Create data for a user
      function createGameRow() {
	  $.post("make_user_row.php", {ID});
      }

      // This does not get a level, it should be named something different
      function getUserLevel() {
	  let level_nr;
	  $.post("get_level.php",
		 {ID},
		 function(response) {
		     level = response.level; 
		     document.getElementById("progress").innerHTML = response.level;
		 }, 'json');
	  return level_nr;
      }

      function setUserLevel() {
	  $.post("set_level.php",
		 {
		     ID,
		     level,
		 });
	  getUserLevel(); //this will make sure the latest level is displayed
      }
      // Perhaps a name would be nice too
      // let lesson_selection = document.createElement("div");

      let num_lessons = 10;
      let offset = 2;
      let level_offsets = new Array(num_lessons).fill(2);
      
      // Generating the boxes for all 10 levels
      for (let i = 1; i <= num_lessons; i++) {
	  let current_lesson_select = make_lesson_selection(`Lesson ${i}`, i, 3, 1, function () {
	      // Load and add level to screen
	      game_box.innerHTML = `You are now in Lesson ${i}, Level ${level_offsets[i - 1]}`;

	      // The exit button lets us save our progress.
	      let exit_button = document.createElement("button");
	      exit_button.innerHTML = "Save Progress";
	      // Go back
	      exit_button.addEventListener("click", save_to_main);
	      
	      game_box.appendChild(exit_button);
	      
	      
	  }, function () {
	      // Put save game functionality in here

	      // Return to menu
	      game_box.innerHTML = "";
	      game_box.appendChild(lesson_selection);
	  });
	  lesson_selection.appendChild(current_lesson_select);
      }
      
    </script>
  </body>
</html>
